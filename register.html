<!DOCTYPE html>
<html>
<head>
<title>GM VEZA HOSPITAL - Complete Invoice System</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#eaf4ff; padding:20px; }
.invoice-container { max-width:1100px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.08); border-top:8px solid #0b63ce; }
.header { display:flex; align-items:center; gap:20px; margin-bottom:20px; }
.logo-left img { width:120px; }
.hospital-title h2 { margin:0; color:#0b63ce; }
.outpatient { margin:0; color:#555; letter-spacing:2px; }
.boxes{ display:flex; justify-content:space-between; margin-bottom:20px; gap:20px; }
.box{ width:48%; border:1px solid #0b63ce; padding:12px; border-radius:6px; background:#f5f9ff; font-size:14px; }
.details { display:flex; gap:20px; margin-bottom:20px; }
.details div { width:50%; }
label { font-weight:bold; color:#0b63ce; margin-top:10px; display:block; }
input, select { width:100%; padding:6px; margin-top:5px; border-radius:5px; border:1px solid #bcd6ff; }
table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px; }
th { background:#0b63ce; color:white; padding:8px; }
td { border:1px solid #cfe2ff; padding:6px; text-align:center; }
.bottom-container { display:flex; justify-content:space-between; margin-top:40px; }
.signature-box { width:40%; text-align:left; }
.signature-line { border-bottom:1px solid #000; width:250px; margin:100px 0 5px 0; }
.totals-box { width:45%; }
.btn { margin-top:15px; padding:8px 16px; background:#0b63ce; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.btn:hover { background:#084a9c; }
@media print { .btn { display:none; } }
</style>
</head>

<body>

<div class="invoice-container" id="invoice">

<div class="header">
  <div class="logo-left"><img src="VEZA.jpeg" alt="VEZA Logo"></div>
  <div class="hospital-title">
    <h2>GM VEZA HOSPITAL</h2>
    <h3 class="outpatient">OUTPATIENT INVOICE</h3>
  </div>
</div>

<div class="boxes">
  <div class="box">
    <strong>From:</strong><br>
    Address: 612-40200<br>
    Tel: 0715513893<br>
    Email: everlinenyaboke5@gmail.com<br>
    PIN: P052389331J
  </div>
  <div class="box">
    <strong>Invoice To:</strong><br>
    SHA - FFS<br>
    NHIF Building, Ragati Road<br>
    P.O Box 30443 - 00100 Nairobi
  </div>
</div>

<div class="details">
  <div>
    <label>Invoice No</label><input type="text" id="invoiceNo">
    <label>Patient Name</label><input type="text" id="patientName">
    <label>Membership No</label><input type="text" id="membershipNo">
  </div>
  <div>
    <label>Claim ID</label><input type="text" id="claimId">
    <label>Created On</label><input type="date" id="createdOn">
    <label>Due Date</label><input type="date" id="dueDate">
  </div>
</div>

<h3 style="text-align:center;color:#0b63ce;">Medical Services</h3>

<table>
<thead>
<tr>
  <th>No</th>
  <th>Description</th>
  <th>Qty (grams)</th>
  <th>Unit Price</th>
  <th>VAT%</th>
  <th>Disc%</th>
  <th>Amount</th>
  <th>Net</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="bottom-container">
  <div class="signature-box">
    <p><strong>For GM Veza Hospital:</strong></p>
    <div class="signature-line"></div>
    <p>Date: ____________________</p>
  </div>
  <div class="totals-box">
    <table>
      <tr><td>Total Amount</td><td id="totalAmount">0.00</td></tr>
      <tr><td>Co-payment</td><td><input type="number" id="copayment" value="0"></td></tr>
      <tr><td>Discount</td><td><input type="number" id="extraDiscount" value="0"></td></tr>
      <tr><td><strong>Balance</strong></td><td id="balance">0.00</td></tr>
    </table>
  </div>
</div>

<button class="btn" onclick="saveRecord()">Save Record</button>
<button class="btn" onclick="downloadPDFFilled()">Download PDF</button>
<button class="btn" onclick="downloadExcel()">Download All Records (Excel)</button>

<h3 style="text-align:center;color:#0b63ce;">Saved Invoices</h3>
<table id="recordsTable">
<thead>
<tr>
  <th>Invoice</th>
  <th>Patient</th>
  <th>Total</th>
  <th>Balance</th>
  <th>Download PDF</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>
const tableBody = document.getElementById("tableBody");

// Full list of drugs (with grams)
const drugOptions = [
  "Paracetamol 500mg", "Amoxicillin 250mg", "Cough Syrup 100ml", "Ibuprofen 400mg",
  "Azithromycin 500mg", "Metronidazole 400mg", "Vitamin C 1000mg", "Diclofenac 50mg",
  "Omeprazole 20mg", "Salbutamol Inhaler", "Ceftriaxone 1g", "Aspirin 75mg",
  "Gentamycin 80mg", "Loperamide 2mg", "Chlorpheniramine 4mg", "Hydrocortisone Cream 10g"
];

// Generate 10 service rows
for(let i=1;i<=10;i++){
  let row = document.createElement("tr");
  row.innerHTML=`<td>${i}</td>
    <td><select>${drugOptions.map(d=>`<option>${d}</option>`).join("")}</select></td>
    <td><input type="number" class="qty" value="1"></td>
    <td><input type="number" class="price" value="0"></td>
    <td><input type="number" class="vat" value="0"></td>
    <td><input type="number" class="disc" value="0"></td>
    <td class="amount">0.00</td>
    <td class="net">0.00</td>`;
  tableBody.appendChild(row);
}

// Calculations
document.addEventListener("input", e=>{
  if(e.target.closest("tr")) calculateRow(e.target.closest("tr"));
  if(e.target.id==="copayment" || e.target.id==="extraDiscount") calculateTotals();
});

function calculateRow(row){
  let qty = parseFloat(row.querySelector(".qty").value)||0;
  let price = parseFloat(row.querySelector(".price").value)||0;
  let vat = parseFloat(row.querySelector(".vat").value)||0;
  let disc = parseFloat(row.querySelector(".disc").value)||0;

  let amount = qty*price;
  let net = amount + (amount*vat/100) - (amount*disc/100);

  row.querySelector(".amount").textContent = amount.toFixed(2);
  row.querySelector(".net").textContent = net.toFixed(2);

  calculateTotals();
}

function calculateTotals(){
  let total=0;
  document.querySelectorAll(".net").forEach(cell=>{total+=parseFloat(cell.textContent)||0;});
  document.getElementById("totalAmount").textContent = total.toFixed(2);
  let copay = parseFloat(document.getElementById("copayment").value)||0;
  let disc = parseFloat(document.getElementById("extraDiscount").value)||0;
  document.getElementById("balance").textContent = (total - copay - disc).toFixed(2);
}

// Save invoice
function saveRecord(){
  let records = JSON.parse(localStorage.getItem("vezaInvoices"))||[];
  let record={
    invoiceNo: document.getElementById("invoiceNo").value,
    patientName: document.getElementById("patientName").value,
    total: document.getElementById("totalAmount").textContent,
    balance: document.getElementById("balance").textContent
  };
  if(!record.invoiceNo || !record.patientName){ alert("Invoice No and Patient Name required!"); return;}
  records.push(record);
  localStorage.setItem("vezaInvoices", JSON.stringify(records));
  displayRecords();
  alert("Invoice saved! Now you can download PDF.");
}

// Display invoices
function displayRecords(){
  let records = JSON.parse(localStorage.getItem("vezaInvoices"))||[];
  let tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML="";
  records.forEach((r,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${r.invoiceNo}</td>
      <td>${r.patientName}</td>
      <td>${r.total}</td>
      <td>${r.balance}</td>
      <td><button onclick="downloadPDFFilled(${i})">Download PDF</button></td>
    </tr>`;
  });
}

// PDF download with Patient Name + Invoice No
async function downloadPDFFilled(index){
  if(index!==undefined){
    const records = JSON.parse(localStorage.getItem("vezaInvoices"))||[];
    const record = records[index];
    if(record){
      document.getElementById("invoiceNo").value = record.invoiceNo;
      document.getElementById("patientName").value = record.patientName;
      document.getElementById("totalAmount").textContent = record.total;
      document.getElementById("balance").textContent = record.balance;
    }
  }

  const invoice = document.getElementById("invoice");
  const inputs = invoice.querySelectorAll("input, select");

  // Replace inputs with text for PDF
  inputs.forEach(input=>{
    const span = document.createElement("span");
    span.textContent = input.value || input.selectedOptions?.[0]?.text || "";
    span.style.fontSize="14px";
    span.style.fontFamily="Arial, sans-serif";
    input.style.display="none";
    input.parentNode.appendChild(span);
  });

  const canvas = await html2canvas(invoice, {scale:2, useCORS:true});
  const imgData = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgHeight = (canvas.height * pageWidth) / canvas.width;

  pdf.addImage(imgData,"PNG",0,0,pageWidth,imgHeight);

  // Force download to device memory
  const patientName = document.getElementById("patientName").value.replace(/\s+/g,"_");
  const invoiceNo = document.getElementById("invoiceNo").value.replace(/\s+/g,"");
  const blob = pdf.output("blob");
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${patientName}_${invoiceNo}.pdf`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // Restore inputs
  inputs.forEach(input=>{
    input.style.display="";
    input.parentNode.querySelector("span")?.remove();
  });
}

// Excel export
function downloadExcel(){
  let records = JSON.parse(localStorage.getItem("vezaInvoices"))||[];
  if(records.length==0){alert("No records!"); return;}
  const ws = XLSX.utils.json_to_sheet(records);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Invoices");
  XLSX.writeFile(wb,"GM_VEZA_Records.xlsx");
}

window.onload = displayRecords;
</script>

</body>
</html>
